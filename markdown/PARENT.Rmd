---
output:
  officedown::rdocx_document: 
    reference_docx: styles_reference3.docx
    pandoc_args: ["--metadata-file=header.yaml"]
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

This is a test of the cross-refs in this doc (Table \@ref(tab:stations-allocated)). And here is a test for figure cross-referencing (Figure \@ref(fig:area-map)).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
library(officedown)
library(officer)
```


# Preface
```{r child=here::here("gdrive","Preface.Rmd")}
```

# Abstract
```{r child=here::here("gdrive","Abstract.Rmd")}
```

# Introduction
```{r child=here::here("gdrive","Introduction.Rmd")}
```

# Methods
```{r child=here::here("gdrive","Methods.Rmd")}
```

<!-- Tables -->
```{r echo=FALSE,tab.cap='Stations allocated and sampled this year.', tab.id='stations-allocated',  tab.cap.style = "Table Caption"}
list_tables[["allocated_sampled"]] %>% 
  #mutate(`Stations per 1,000 km^2` = round(`Stations per 1,000 km^2`,digits = 1)) %>%
  flextable() %>% 
  theme_vanilla() %>%
  fontsize(size = 8.5,part = 'all') %>% 
  line_spacing(space = 0.5) %>%
  width(j = 1, width = 2, unit = "in") %>%
  width(j = 2, width = 1.2, unit = "in") %>%
  compose(part = "header", i = 1, j = 7,
         value = as_paragraph("Stations per 1,000 km",
                              as_sup("2")))
```

<br />
  
```{r echo=FALSE,tab.cap='Target numbers of length samples for each managed species.', tab.id='length-sample-sizes',  tab.cap.style = "Table Caption"}
list_tables[["targetn"]]%>%
  flextable(col_keys = c("dummy_col", "Target.sample.size")) %>%
  flextable::mk_par(
    j = "dummy_col",
    value = as_paragraph(Species.or.species.group, " (", as_i(sci.name), sci.name.addendum, ")")
  ) %>%
  set_header_labels(
    dummy_col = "Species or species group",
    Target.sample.size = "Target sample size"
  ) %>%
  theme_vanilla() %>%
  fontsize(size = 8.5, part = "all") %>%
  width(j = 1, width = 4, unit = "in") %>%
  line_spacing(space = 0.75)

```

<br />

```{r echo=FALSE,tab.cap='Number of otoliths collected by INPFC area and depth range.', tab.id='otolith-sample-summary',  tab.cap.style = "Table Caption"}
otos_collected  %>% 
  dplyr::rename("INPFC Area" = "INPFC_AREA") %>%
  flextable() %>%  
  theme_vanilla() %>%
  fontsize(size = 8.5,part = 'all') %>% 
  width(j = 1, width = 2.5, unit = "in") %>%
  width(j = 2, width = 1.2, unit = "in") %>%
  width(j = 3, width = 2.5, unit = "in") %>%
  line_spacing(space = 0.5)
```

<br />

<!-- Figures -->
```{r fig.cap='Map of the Aleutian Islands 2018 bottom trawl survey area indicating survey districts (WAI = Western Aleutian Islands, CAI = Central Aleutian Islands, EAI = Eastern Aleutian Islands, and SBS = Southern Bering Sea), isobaths from 100â€“500 m and stations sampled (black dots).', fig.id='area-map',  fig.cap.style = "Figure Caption"}
include_graphics(here::here(img1_path))
```

<!-- NOTE: Figures after this first one are all per species until the appendix. -->


# Results

```{r child=here::here("gdrive","Results.Rmd")}
```

```{r, echo=FALSE, results='asis'}
# report_species contains the list of species in the report 
src <- list()

for (i in 1:nrow(report_species)) { # 
  species_code <- report_species$species_code[i]
  spp_name_informal <- report_species$spp_name_informal[i]
  spp_name_scientific <- report_species$spp_name_scientific[i]
  middle_sentences <- blurbs$middle_sentences[which(blurbs$species_code == species_code)]
  year <- maxyr
  region <- survname_long

  spps_ordered_by_biomass <- biomass_maxyr %>%
    dplyr::arrange(-TOTAL_BIOMASS)
  xth <- which(spps_ordered_by_biomass$SPECIES_CODE == species_code)

  xx <- filter(
    top_CPUE,
    species_code == species_code & INPFC_AREA %in% c(
      "Central Aleutians",
      "Eastern Aleutians",
      "Southern Bering Sea",
      "Western Aleutians"
    )
  ) %>% # Subset only to the areas
    dplyr::top_n(n = 2, wt = wgted_mean_cpue_kgha) %>%
    dplyr::select(INPFC_AREA)

  top_cpue <- xx[[1]][1]
  second_top_cpue <- xx[[1]][2]

  species_biomass <- format(round(spps_ordered_by_biomass$TOTAL_BIOMASS[which(spps_ordered_by_biomass$SPECIES_CODE == species_code)]), big.mark = ",")
  # format(round(as.numeric(1000.64), 1), nsmall=1, big.mark=",")

  middle_sentences <- blurbs[which(blurbs$species_code == species_code), "middle_sentences"]

  region_largest <- meanlengths_area %>%
    dplyr::filter(SPECIES_CODE == species_code) %>%
    top_n(1, `Mean length`) %>%
    dplyr::select(INPFC_AREA) %>%
    as.character()

  src[[i]] <- knitr::knit_expand(here::here("markdown", "SpeciesResultTemplate.Rmd"))
}

res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
cat(res, sep = "\n")
```

