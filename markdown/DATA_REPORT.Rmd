---
title: "2025 Gulf of Alaska Biennial Bottom Trawl Survey"
subtitle: "Data Report"
author: "Bethany Riggle, Alexandra Dowlin, Zack Oyafuso, Ned Laman, Margaret Siple"
output:
  officedown::rdocx_document: 
    reference_docx: styles_reference4.docx
    pandoc_args: ["--metadata-file=header.yaml"]
    tables:
      caption:
        pre: "Table "
        sep: ". --"
    plots:
      caption:
        pre: "Figure "
        sep: ". -- "
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, dev = "ragg_png",
  tab.cap.style = "Table caption",
  tab.cap.pre = "Table",
  tab.cap.sep = ". --",
  fig.cap.style = "Image caption",
  fig.cap.pre = "Figure ",
  fig.cap.sep = ". -- ",
  fig.align = "center",crop = TRUE
)

library(officedown)
library(officer)
```

# Preface
```{r child=here::here("gdrive","Preface.Rmd")}
```
\newpage

# Abstract
```{r child=here::here("gdrive","Abstract.Rmd")}
```

\newpage

# Introduction
```{r child=here::here("gdrive","Introduction.Rmd")}
```

# Methods
```{r child=here::here("gdrive","Methods.Rmd")}
```

```{r fig.cap=paste("Diagram of the Poly Nor'eastern bottom trawl gear used in the",maxyr,survname_long, "survey"), fig.id='net-diagram',  fig.cap.style = "Figure Caption", fig.width = 8, dpi = 300}
include_graphics(path = here::here("img/Poly_NorE_Bottom Trawl.png"))
```

\newpage
<!-- Tables -->

```{r echo=FALSE,tab.cap=paste0('Ex-vessel prices used to allocate stations in the ', SRVY, ' ', maxyr, ' bottom trawl survey. The prices used for station allocation in ', maxyr, ' are from ', maxyr-2, '.'), tab.id='sp-prices',  tab.cap.style = "Table caption"}
sp_prices |>
  dplyr::select(`Common name`,`Scientific name`,`Ex-vessel price`,`Included in design`) |>
  dplyr::rename("Ex-vessel price (USD per lb)" = "Ex-vessel price") |>
  dplyr::filter(`Included in design` == "Y") |>
  dplyr::select(-`Included in design`) |>
  flextable() |>
  fix_border_issues() |>
  theme_vanilla() |>
  fontsize(size = 10, part = "all") |>
  italic(j = 2, part = "body") |>
  line_spacing(space = 0.75) |>
  align(align = "center", part = "all") |>
  align(j = c(1, 2), align = "left", part = "body") |>
  autofit()
```

\newpage

```{r echo=FALSE,tab.cap=paste('Stations allocated and sampled during the', maxyr, SRVY,'bottom trawl survey.'), tab.id='stations-allocated',  tab.cap.style = "Table caption"}
list_tables[["allocated_sampled"]] |>
  # allocated_sampled %>%
  mutate(
    `Total area` = round(`Total area`, digits = 0),
    `Stations per 1,000 km^2` = round(`Stations per 1,000 km^2`, digits = 2)
  ) |>
  flextable() |>
  merge_v(j = ~`NMFS area`) |>
  fix_border_issues() |>
  theme_vanilla() |>
  fontsize(size = 8.5, part = "all") |>
  line_spacing(space = 0.75) |>
  fit_to_width(max_width = 7.5, unit = "in") |>
  compose(
    part = "header", i = 1, j = 7,
    value = as_paragraph(
      "Stations per 1,000 km",
      as_sup("2")
    )
  ) |>
  compose(
    part = "header", i = 1, j = 6,
    value = as_paragraph(
      "Total area (km",
      as_sup("2"), ")"
    )
  ) |>
  align(align = "center", part = "all") |>
  align(j = 1:2, align = "left", part = "body") |>
  hline(i = ~ break_position(`NMFS area`), border = fp_border(color = "#5A5A5A", width = 3))

```
\newpage

```{r echo=FALSE,tab.cap='Target numbers per haul of length samples for each managed species. Asterisk (*) indicates species that are not sexed; all other species are collected as sexed lengths.', tab.id='length-sample-sizes',  tab.cap.style = "Table caption"}
list_tables[["length-sample-sizes"]] %>%
  flextable(col_keys = c("dummy_col", "Target.sample.size")) %>%
  flextable::mk_par(
    j = "dummy_col",
    value = as_paragraph(Species.or.species.group, " (", as_i(sci.name), sci.name.addendum, ")")
  ) %>%
  set_header_labels(
    dummy_col = "Species or species group",
    Target.sample.size = "Target sample size"
  ) %>%
  theme_vanilla() %>%
  fontsize(size = 8.5, part = "all") %>%
  align(i = 1, j = 2, align = "center", part = "header") %>%
  align(j = 2, align = "center", part = "body") %>%
  autofit() %>%
  line_spacing(space = 0.75)

```

\newpage
<br />

<!-- Figures -->
```{r fig.cap=ifelse(SRVY=="AI",'Map of the Aleutian Islands 2024 bottom trawl survey area indicating survey districts (WAI = Western Aleutian Islands, CAI = Central Aleutian Islands, EAI = Eastern Aleutian Islands, SBS = Southern Bering Sea).', 'Map of the GOA 2025 bottom trawl survey area indicating NMFS areas. Black points indicate stations sampled in this survey.'), fig.id='area-map',  fig.cap.style = "Figure Caption", fig.asp = 0.7, fig.width = 6.5, dpi = 300}
# if(SRVY=="AI"){include_graphics(here::here(img1_path))}else{station_map}
station_map
```


# Results

```{r child=here::here("gdrive","Results_part1.Rmd")}
```

<br />
<br />

```{r echo=FALSE,tab.cap='Otolith samples collected compared to otolith targets. A negative percent difference indicates an otolith sample shortfall; positive percent difference indicates that the target was exceeded.', tab.id='otolith-goal-sample-summary',  tab.cap.style = "Table caption"}

  list_tables[["otos_target_sampled"]] |>
    dplyr::rename(
      "Species" = "species",
      "Target N" = "target",
      "N collected" = "collection",
      "Percent difference between target and collection" = "percent.diff"
    ) %>%
    flextable() |>
    theme_vanilla() |>
    fontsize(size = 9, part = "all") |>
    line_spacing(space = 0.5) |>
    align(align = "center", part = "all") |>
    align(j = 1, align = "left", part = "body") |>
    autofit()

```

<br />
<br />

```{r fig.cap='Bottom temperature measured at the headrope of the trawl. Larger brown points represent the median. Shaded distributions represent the density of measurements. Horizontal lines show the mean bottom (gear) temperature over the past 10 and 20 years.', fig.id='bottom-temp',  fig.cap.style = "Figure Caption", fig.width=6}
list_temperature[['bottomtemp']]
```

<br />
<br />

```{r fig.cap='Surface temperatures from the survey. Larger brown points represent the median. Shaded distributions represent the density of measurements. Horizontal lines show the mean surface temperature over the past 10 and 20 years.', fig.id='surface-temp',  fig.cap.style = "Figure Caption", fig.width=6}
list_temperature[['surfacetemp']]
```

<br />
<br />



<!-- NOTE: Figures after this first one are all per species until the appendix. -->

```{r child=here::here("gdrive","Results_part2.Rmd")}
```

\newpage

<!---BLOCK_MULTICOL_START--->
```{r echo=FALSE,tab.cap=paste('Mean CPUE [kg/ha] for the 20 most abundant groundfish species in each survey regulatory area during the', maxyr, SRVY, 'bottom trawl survey.'), tab.id='top-cpue', tab.cap.style = "Table caption"}
top_CPUE_formatted(top_CPUE = top_CPUE) |>
  as_grouped_data(groups = "NMFS area") |>
  as_flextable(hide_grouplabel = TRUE) |>
  set_header_labels(`INPFC area` = "") |>
  bold(bold = TRUE, part = "header") |>
  align(i = ~ !is.na(`NMFS area`), align = "center") |>
  bold(i = ~ !is.na(`NMFS area`)) |>
  fit_to_width(max_width = 2, unit = "in") |>
  padding(padding.bottom = 0, padding.top = 0) |>
  fontsize(size = 8, part = "all")

```

<!---BLOCK_MULTICOL_STOP{widths: [2,2,2], space: 0.07, sep: true}--->

<br />

```{r, echo=FALSE, results='asis'}
# report_species contains the list of species in the report
src <- list()

for (i in 1:3) { # nrow(report_species)

  species_code <- report_species$species_code[i]

  spp_name_informal <- report_species$spp_name_informal[i]
  spp_name_informal_sen <- stringr::str_to_sentence(string = spp_name_informal)
  spp_name_informal_low <- stringr::str_to_lower(string = spp_name_informal)
  spp_name_scientific <- report_species$spp_name_scientific[i]

  year <- maxyr
  region <- survname_long

  spps_ordered_by_biomass <- biomass_maxyr %>% 
    dplyr::arrange(-BIOMASS_MT)
  xth <- which(spps_ordered_by_biomass$SPECIES_CODE == species_code)

  species_biomass0 <- format(
    round(spps_ordered_by_biomass$BIOMASS_MT[which(spps_ordered_by_biomass$SPECIES_CODE == species_code)]),
    big.mark = ","
  )
  species_biomass <- paste0(species_biomass0, "&nbsp;", "mt")

  # Percent change in B since compareyr and maxyr
  spp_percent_change1 <- compare_tab$percent_change[which(compare_tab$SPECIES_CODE == species_code)]
  spp_percent_change <- abs(spp_percent_change1)
  spp_incr_decr <- ifelse(spp_percent_change1 < 0, "decrease", "increase")

  nmfs_highest_biomass <- table3s_list[paste(report_species$species_code[i])][[1]] |>
    mutate(`NMFS area` = na_if(`NMFS area`, "")) |>
    filter(`NMFS area` != "All areas") %>% # take out the total
    mutate(biomass_numeric = as.numeric(gsub(",", "", `Biomass (mt)`))) |>
    filter(biomass_numeric == max(biomass_numeric, na.rm = TRUE)) |>
    dplyr::select(`NMFS area`) %>%
    {
      if (SRVY == "AI") left_join(., region_lu2, by = c("Survey district" = "REGULATORY_AREA_NAME")) %>% dplyr::select(., `INPFC_AREA_ABBREV`) else . # WILL NEED TO FIX THIS IN 2026!
    } %>%
    as.character()

  nmfs_highest_cpue <- table3s_list[paste(report_species$species_code[i])][[1]] %>%
    mutate(`NMFS area` = na_if(`NMFS area`, "")) %>%
    filter(`NMFS area` != "All areas") %>% # take out the total
    {
      if (SRVY == "AI") filter(., `Survey district` != "Combined Aleutian Districts") else .
    } %>%
    mutate(cpue_numeric = as.numeric(gsub(",", "", `CPUE (kg/km2)`))) %>%
    dplyr::slice_max(cpue_numeric, n = 2) %>%
    dplyr::select(`NMFS area`) %>%
    {
      if (SRVY == "AI") { # WILL NEED TO FIX THIS IN 2026!
        # left_join(., region_lu2, by = c("NMFS area" = "INPFC_AREA")) %>%
        #   dplyr::select(., `INPFC_AREA_ABBREV`)
      } else {
        .
      }
    } %>%
    magrittr::extract2(1)
  # 
  depth_highest_biomass0 <- table4s_list[paste(report_species$species_code[i])][[1]] %>%
    dplyr::mutate(biomass_numeric = chr_to_num(`Biomass (mt)`)) %>%
    filter(biomass_numeric == max(biomass_numeric, na.rm = TRUE)) %>%
    as.character()
  depth_highest_biomass <- paste0(depth_highest_biomass0, "&nbsp;", "m")
  # 
  # Octopus
  if (species_code == 78403) { # true/false, if it's for octopus don't make length comp or length scatter figs and use a different template maybe
    src[[i]] <- knitr::knit_expand(here::here("markdown", "InvertebrateResultTemplate.Rmd"))
  } else {
  # Fish and fish complexes
    region_longest <- meanlengths_area %>%
      dplyr::filter(SPECIES_CODE == species_code) %>%
      top_n(1, `Mean length`) %>%
      {
        ifelse(SRVY == "AI", dplyr::select(., INPFC_AREA_ABBREV), dplyr::select(., REGULATORY_AREA_NAME))
      } %>%
      as.character()

    depth_longest0 <- meanlengths_depth %>%
      dplyr::filter(SPECIES_CODE == species_code) %>%
      top_n(1, `Mean length`) %>%
      dplyr::select(`Depth range`) %>%
      as.character()
    depth_longest <- gsub(pattern = " ", replacement = "&nbsp;", x = depth_longest0)

    spp_n_length <- meanlengths_area %>%
      dplyr::filter(SPECIES_CODE == species_code) %>%
      summarize(sum(N)) %>%
      as.numeric() %>%
      format(big.mark = ",")

    if (species_code %in% c(232, 420, 435, 440, 471, 472, 480)) {
      skate_len_sentence <- "Note that prior to 1999, skate lengths were measured as body length (without tail)."
    }else{
      skate_len_sentence <- ""
    }

    if (species_code %in% c(30060, 10110, 21740, 21720, 10120, 20510)) { # "the big six"
      # Check if there is a sex difference
      sex_diff_sentence <- sex_diff_size_statement(species_lengths = dplyr::filter(sizecomp, SPECIES_CODE == species_code & YEAR == maxyr))
      # If no difference, don't show the bullet point about it
      show.text <- ifelse(sex_diff_sentence == "", FALSE, TRUE)
      # If it's not in the "big six" don't show the bullet point about it
    } else {
      show.text <- FALSE
    }

    # Complexes
    if (grepl(("[[:alpha:]]"), species_code)) {
      c_lookup <- dplyr::filter(complex_lookup, complex == species_code)
      f0 <- complex_lookup[which(complex_lookup$complex == species_code), ]
      f1 <- f0[1:(nrow(f0) - 1), ]
      f2 <- paste0(f1$common_name, " (*", f1$species_name, "*), ")
      f3 <- f0[nrow(f0), ]
      f4 <- paste0(f3$common_name, " (*", f3$species_name, "*)")
      src[[i]] <- knitr::knit_expand(here::here("markdown", "ComplexResultTemplate.Rmd"))
    } else {
      # Individual species
      src[[i]] <- knitr::knit_expand(here::here("markdown", "FishResultTemplate.Rmd"))
    }
  } # / end if() statement about invertebrates (octopus!)
} # end for loop
res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
cat(res, sep = "\n")
```

# Acknowledgments
```{r child=here::here("gdrive","Acknowledgments.Rmd")}
```

# Appendices
